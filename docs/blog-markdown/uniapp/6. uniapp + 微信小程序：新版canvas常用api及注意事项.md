# uniapp + å¾®ä¿¡å°ç¨‹åºï¼šæ–°ç‰ˆcanvaså¸¸ç”¨apiåŠæ³¨æ„äº‹é¡¹

# å…³äºæ–°æ—§canvasçš„æ¯”è¾ƒæˆ‘ä»¥å‰å†™è¿‡ä¸€ç¯‡åšå®¢ ï¼šhttps://www.cnblogs.com/sunshine233/p/17014701.html ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†ã€‚

ä½†åœ¨æ­£æ–‡å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä¸å¾—ä¸å†è¯´ä¸€éå¾®ä¿¡çš„æ–‡æ¡£å†™çš„çœŸåƒåœ¾ã€‚å¾ˆå¤šé—®é¢˜çš„ç­”æ¡ˆéƒ½æ˜¯åœ¨å¾®ä¿¡å¼€å‘è€…ç¤¾åŒºé‡Œæ‰¾åˆ°çš„ã€‚

#  ä¸€ã€æ–°ç‰ˆcanvas åŸºç¡€ç”¨æ³•ï¼š

```
<template>
    <view>
        <view class="divider">æ–°ç‰ˆcanvas ğŸ‘‡</view>
        <!-- 1. canvas-id æ¢æˆäº† id -->
        <!-- 2. å¢åŠ äº† type="2d" è¡¨ç¤ºæ–°ç‰ˆcanvas -->
        <canvas id="myCanvas" type="2d" ></canvas>
    </view>
</template>

<script>
    export default {
        data() {
            return {}
        },
        mounted() {
            this.newCanvas();
        },
        methods: {
            newCanvas() {
                // 3. è·å–canvasèŠ‚ç‚¹çš„æ–¹å¼å˜äº†ï¼Œå¿…é¡»æŒ‰ç…§è¿™ä¸ªæ ¼å¼å†™
                // 3.1 å¦‚æœä¸æ˜¯ç›´æ¥é¡µé¢è€Œæ˜¯å­é¡µé¢ï¼ŒæŠŠ wx æ”¹æˆ thisï¼Œå¦åˆ™è·å–ä¸åˆ° nodeèŠ‚ç‚¹
                // ä¹Ÿå°±æ˜¯ wx.createSelectorQuery()  å…¶å¥¹éƒ¨åˆ†ä¸€æ ·
                wx.createSelectorQuery()
                    .select('#myCanvas')
                    .node(({
                        node: canvas
                    }) => {
                        //4. è·å–æ­£ç¡®å®ä¾‹
                        const ctx = canvas.getContext('2d');
    
                        ctx.fillStyle = "green";
                        ctx.fillRect(0, 0, 50, 50);
                        // 4.1 è®¾ç½®å­—ä½“å¤§å°ï¼ˆä¸¤ä¸ªå‚æ•°å¿…é¡»éƒ½å†™ï¼‰
                        ctx.font = "20px sans-serif";
                        // 4.2 å†™æ–‡å­—
                        ctx.fillText("æˆ‘æ˜¯æ–°ç‰ˆcanvas", 50, 30);
                        // 4.3 æ–°ç‰ˆ canvas ä¸éœ€è¦è°ƒç”¨ draw()
                        // ctx.draw(); 
                    }).exec();
            },
        }
    }
</script>

<style scoped>
    .divider {
        margin: 10px 0;
    }

    canvas {
        background-color: antiquewhite;
    }
</style>
```

ä»£ç ä¸­è·å–å®ä¾‹çš„å†™æ³•å’Œå®˜æ–¹å®ä¾‹æ•ˆæœä¸€æ ·

![img](https://img2024.cnblogs.com/blog/2194212/202502/2194212-20250224152737434-84669005.png)

 è¿è¡Œç»“æœï¼š

![img](https://img2024.cnblogs.com/blog/2194212/202502/2194212-20250224152459638-878269718.png)

# äºŒã€æ–°ç‰ˆcanvasç”»å›¾æ¨¡ç³Šå¤±çœŸ

ä½†canvaså®é™…ä¸Šæœ‰ä¸¤ç§è®¾ç½®å°ºå¯¸çš„æ–¹å¼ï¼š

- ä¸€ç§æ˜¯é»˜è®¤å°ºå¯¸300*150ï¼ˆæ–‡æ¡£ä¸­å†™å¯ä»¥ç›´æ¥ç”¨ <canvas id="myCanvas" type="2d" width="300" height="300"></canvas> ä¿®æ”¹ï¼Œä½†æˆ‘2025/2/24å°è¯•å¥½åƒä¸èµ·æ•ˆäº†ï¼‰ï¼›
- ä¸€ç§æ˜¯åœ¨cssä¸­è®¾ç½® canvas { width: 300px; height: 300px; } 

è¿™ä¸¤ä¸ªå°ºå¯¸è¢«æˆä¸º[æ¸²æŸ“å®½é«˜å’Œé€»è¾‘å®½é«˜](https://developers.weixin.qq.com/miniprogram/dev/framework/ability/canvas.html)ã€‚ä½†æˆ‘è§‰å¾—å¾®ä¿¡æ–‡æ¡£å†™çš„ä¼¼ä¹æœ‰ç‚¹é—®é¢˜ä¸”æ¨¡ç³Šä¸æ¸…ã€‚

![img](https://img2024.cnblogs.com/blog/2194212/202502/2194212-20250224154620301-2099265022.png)

æŸ¥äº†åˆ«çš„æ–‡æ¡£ + å®è·µï¼Œæˆ‘å‘ç°å¦‚æœåœ¨cssä¸­æ‰‹åŠ¨è®¾ç½®äº†canvasçš„å®½é«˜ï¼Œç”»å›¾å°±ä¼šå‡ºç°æ¨¡ç³Šï¼ˆå› ä¸ºcanvaWidthå’ŒstyleWidthä¸ä¸€è‡´ï¼‰ã€‚

å’Œä¸Šä¸€æ®µä»£ç å·®å¼‚åªå¢åŠ äº†css

```
<template>
    <view>
        <view class="divider">æ–°ç‰ˆcanvas ğŸ‘‡</view>
        <!-- 1. canvas-id æ¢æˆäº† id -->
        <!-- 2. å¢åŠ äº† type="2d" è¡¨ç¤ºæ–°ç‰ˆcanvas -->
        <canvas id="myCanvas" type="2d" ></canvas>
    </view>
</template>

<script>
    export default {
        data() {
            return {}
        },
        mounted() {
            this.newCanvas();
        },
        methods: {
            newCanvas() {
                // 3. è·å–canvasèŠ‚ç‚¹çš„æ–¹å¼å˜äº†ï¼Œå¿…é¡»æŒ‰ç…§è¿™ä¸ªæ ¼å¼å†™
                // 3.1 å¦‚æœä¸æ˜¯ç›´æ¥é¡µé¢è€Œæ˜¯å­é¡µé¢ï¼ŒæŠŠ wx æ”¹æˆ thisï¼Œå¦åˆ™è·å–ä¸åˆ° nodeèŠ‚ç‚¹
                // ä¹Ÿå°±æ˜¯ wx.createSelectorQuery()  å…¶å¥¹éƒ¨åˆ†ä¸€æ ·
                wx.createSelectorQuery()
                    .select('#myCanvas')
                    .node(({
                        node: canvas
                    }) => {
                        //4. è·å–æ­£ç¡®å®ä¾‹
                        const ctx = canvas.getContext('2d');
    
                        ctx.fillStyle = "green";
                        ctx.fillRect(0, 0, 50, 50);
                        // 4.1 è®¾ç½®å­—ä½“å¤§å°ï¼ˆä¸¤ä¸ªå‚æ•°å¿…é¡»éƒ½å†™ï¼‰
                        ctx.font = "20px sans-serif";
                        // 4.2 å†™æ–‡å­—
                        ctx.fillText("æˆ‘æ˜¯æ–°ç‰ˆcanvas", 50, 30);
                    
                        // 4.3 æ–°ç‰ˆ canvas ä¸éœ€è¦è°ƒç”¨ draw()
                        // ctx.draw(); 
                    }).exec();
            },
        }
    }
</script>

<style scoped>
    .divider {
        margin: 10px 0;
    }

    canvas {
        background-color: antiquewhite;
        width: 300px;
        height: 300px;
    }
</style>
```

![img](https://img2024.cnblogs.com/blog/2194212/202502/2194212-20250224154953413-1564103644.png)

 æƒ³è§£å†³æ¨¡ç³Šå¤±çœŸçš„é—®é¢˜å°±è¦ä½¿ç”¨ canvas.width = styleWidth*dpr; canvas.height = styleHeight*dpr; ä¹Ÿå°±æ˜¯é‡æ–°è®¾ç½®canvasçš„å°ºå¯¸ç­‰äºcssä¸­çš„å°ºå¯¸*åƒç´ æ¯”ã€‚

è·å–åƒç´ æ¯”å¾®ä¿¡å·²ç»ç»™å‡ºäº†api ï¼š const dpr = wx.getWindowInfo().pixelRatio; 

ç°åœ¨cssä¸­å®½é«˜è®¾ç½®çš„éƒ½æ˜¯300ï¼Œ æ‰€ä»¥è¦è®¾ç½® canvas.width = 300* dpr; canvas.height = 300 * dpr; æœ€åç¼©æ”¾ ctx.scale(dpr, dpr); 

```
<template>
    <view>
        <view class="divider">æ–°ç‰ˆcanvas ğŸ‘‡</view>
        <!-- 1. canvas-id æ¢æˆäº† id -->
        <!-- 2. å¢åŠ äº† type="2d" è¡¨ç¤ºæ–°ç‰ˆcanvas -->
        <canvas id="myCanvas" type="2d" ></canvas>
    </view>
</template>

<script>
    export default {
        data() {
            return {}
        },
        mounted() {
            this.newCanvas();
        },
        methods: {
            newCanvas() {
                // 3. è·å–canvasèŠ‚ç‚¹çš„æ–¹å¼å˜äº†ï¼Œå¿…é¡»æŒ‰ç…§è¿™ä¸ªæ ¼å¼å†™
                // 3.1 å¦‚æœä¸æ˜¯ç›´æ¥é¡µé¢è€Œæ˜¯å­é¡µé¢ï¼ŒæŠŠ wx æ”¹æˆ thisï¼Œå¦åˆ™è·å–ä¸åˆ° nodeèŠ‚ç‚¹
                // ä¹Ÿå°±æ˜¯ wx.createSelectorQuery()  å…¶å¥¹éƒ¨åˆ†ä¸€æ ·
                wx.createSelectorQuery()
                    .select('#myCanvas')
                    .node(({
                        node: canvas
                    }) => {
                        //4. è·å–æ­£ç¡®å®ä¾‹
                        const ctx = canvas.getContext('2d');
                     
                        const dpr = wx.getWindowInfo().pixelRatio;
                        console.log("default canvas.width:", canvas.width,
                         " default canvas.height:", canvas.height);
                        console.log("dpr:", dpr);
                        canvas.width = 300* dpr;
                        canvas.height = 300 * dpr;
                        ctx.scale(dpr, dpr);

                        ctx.fillStyle = "green";
                        ctx.fillRect(0, 0, 50, 50);
                        // 4.1 è®¾ç½®å­—ä½“å¤§å°ï¼ˆä¸¤ä¸ªå‚æ•°å¿…é¡»éƒ½å†™ï¼‰
                        ctx.font = "20px sans-serif";
                        // 4.2 å†™æ–‡å­—
                        ctx.fillText("æˆ‘æ˜¯æ–°ç‰ˆcanvas", 50, 30);

                        // 4.3 æ–°ç‰ˆ canvas ä¸éœ€è¦è°ƒç”¨ draw()
                        // ctx.draw(); 
                    }).exec();
            },
        }
    }
</script>

<style scoped>
    .divider {
        margin: 10px 0;
    }

    canvas {
        background-color: antiquewhite;
        width: 300px;
        height: 300px;
    }
</style>
```

![img](https://img2024.cnblogs.com/blog/2194212/202502/2194212-20250224155520075-1435097000.png)

 å¦‚æœæƒ³ç”¨åŠ¨æ€æ•°æ®å¯ä»¥ç”¨ 

```
<template>
    <view>
        <view class="divider">æ–°ç‰ˆcanvas ğŸ‘‡</view>
        <!-- 1. canvas-id æ¢æˆäº† id -->
        <!-- 2. å¢åŠ äº† type="2d" è¡¨ç¤ºæ–°ç‰ˆcanvas -->
        <canvas id="myCanvas" type="2d" :style="{width:styleWidth+'px',height:styleHeight+'px'}" ></canvas>
    </view>
</template>

<script>
    export default {
        data() {
            return {
                styleWidth:200,
                styleHeight:100
            }
        },
        mounted() {
            this.newCanvas();
        },
        methods: {
            newCanvas() {
                // 3. è·å–canvasèŠ‚ç‚¹çš„æ–¹å¼å˜äº†ï¼Œå¿…é¡»æŒ‰ç…§è¿™ä¸ªæ ¼å¼å†™
                // 3.1 å¦‚æœä¸æ˜¯ç›´æ¥é¡µé¢è€Œæ˜¯å­é¡µé¢ï¼ŒæŠŠ wx æ”¹æˆ thisï¼Œå¦åˆ™è·å–ä¸åˆ° nodeèŠ‚ç‚¹
                // ä¹Ÿå°±æ˜¯ wx.createSelectorQuery()  å…¶å¥¹éƒ¨åˆ†ä¸€æ ·
                wx.createSelectorQuery()
                    .select('#myCanvas')
                    .node(({
                        node: canvas
                    }) => {
                        //4. è·å–æ­£ç¡®å®ä¾‹
                        const ctx = canvas.getContext('2d');
                     
                        const dpr = wx.getWindowInfo().pixelRatio;
                        console.log("default canvas.width:", canvas.width,
                         " default canvas.height:", canvas.height);
                        console.log("dpr:", dpr);
                        canvas.width = this.styleWidth* dpr;
                        canvas.height = this.styleHeight * dpr;
                        ctx.scale(dpr, dpr);

                        ctx.fillStyle = "green";
                        ctx.fillRect(0, 0, 50, 50);
                        // 4.1 è®¾ç½®å­—ä½“å¤§å°ï¼ˆä¸¤ä¸ªå‚æ•°å¿…é¡»éƒ½å†™ï¼‰
                        ctx.font = "20px sans-serif";
                        // 4.2 å†™æ–‡å­—
                        ctx.fillText("æˆ‘æ˜¯æ–°ç‰ˆcanvas", 50, 30);

                        // 4.3 æ–°ç‰ˆ canvas ä¸éœ€è¦è°ƒç”¨ draw()
                        // ctx.draw(); 
                    }).exec();
            },
        }
    }
</script>

<style scoped>
    .divider {
        margin: 10px 0;
    }

    canvas {
        background-color: antiquewhite;
    }
</style>            
```

![img](https://img2024.cnblogs.com/blog/2194212/202502/2194212-20250224155940685-1345758220.png)

#  ä¸‰ã€æ–°ç‰ˆcanvasæ˜“é”™api

## idä¸èƒ½ç”¨æ•°å­—å¼€å¤´ï¼Œå­—ç¬¦ä¸²çš„æ•°å­—ä¹Ÿä¸è¡Œ

## æ‹¬å·èµ‹å€¼å˜æˆäº†ç­‰å·èµ‹å€¼

æ—§ç‰ˆï¼š ctx.setFillStyle("red"); ctx.fillRect(50, 50, 75, 75); 

æ–°ç‰ˆï¼š // è®¾ç½®çš„æ–¹å¼ä» ctx.setFillStyle("red") æ”¹æˆäº† ctx.fillStyle = "red"; ctx.fillStyle = "red"; ctx.fillRect(50, 50, 75, 75); 

## ç”»å›¾ç‰‡

æ—§ç‰ˆï¼š ctx.drawImage("/static/cherry.png, 0,0,100,100"); 

æ–°ç‰ˆï¼š 

```
const image = canvas.createImage();
image.src = "/static/cherry.png";
image.onload = () => {
    //ç­‰å¾…å›¾ç‰‡èµ„æºåŠ è½½å®Œæˆæ‰å¯ä»¥ç”»
    ctx.drawImage(image, 0, 0,100,100);
}
```

 ![img](https://img2024.cnblogs.com/blog/2194212/202502/2194212-20250224165102142-387271707.png) 

## è®¾ç½®æ–‡å­—å¤§å°

æ—§ç‰ˆï¼š ctx.setFontSize(20); ctx.fillText('20', 20, 20); 

æ–°ç‰ˆï¼š ctx.font = "20px sans-serif"; ctx.fillText("æˆ‘æ˜¯æ–°ç‰ˆcanvas", 50, 30); 

## å®æ—¶åˆ·æ–°æŠ–åŠ¨ç™½å±

è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œå¦‚æœéœ€è¦å®æ—¶æ›´æ–°æ•°æ®ï¼Œå°±éœ€è¦canvasä¸åŒç»˜ç”»ï¼Œä½†ä¸è¦å¤šæ¬¡è¿è¡Œ const ctx = canvas.getContext('2d'); å¦åˆ™é¡µé¢åˆ·æ–°æ—¶ä¼šæœ‰ç™½å±æŠ–åŠ¨ã€‚

æ­£ç¡®çš„åšæ³•æ˜¯åˆ†ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªåˆå§‹åŒ–contextï¼Œä¸€ä¸ªåªä¸“å¿ƒç”»å†…å®¹ã€‚

ä¸‹é¢æ˜¯æˆ‘çš„ä¸€éƒ¨åˆ†ä»£ç ï¼ˆä¸èƒ½ç›´æ¥è¿è¡Œï¼Œåˆ å»äº†éƒ¨åˆ†æ•æ„Ÿä¿¡æ¯ï¼‰

```
<template>
    <view>
        <view v-for="item in tankList">
            <canvas type="2d" :id="item.id" class="canvas" ></canvas>
        </view>
    </view>
</template>

<script>

export default {
    props: {
        tankList: {
            type: Array,
            default: []
        }
    },
    data() {
        return {
            // æ²¹ç½å›¾ç‰‡çš„å®½é«˜
            bgimgWidth: 200,
            bgimgHeight: 150,

            context: [],
            bgImg: null
        }
    },
    mounted() {
        this.createContexts(this.bgimgWidth, this.bgimgHeight);//æ¯æ¬¡è¿›æ¥çš„æ—¶å€™å…ˆç”»ä¸€æ¬¡
    },
    watch: {
        tankList(newValue, oldValue) {
            // if é˜²æ­¢æ²¡æœ‰contextè¿˜è¦ç”»å›¾æŠ¥é”™
            if (this.context.length != 0) {
                this.refreshCanvas(this.bgimgWidth, this.bgimgHeight);
            }
        }
    },
    methods: {
        // è¿™ä¸ªé¡µé¢åªè¿è¡Œä¸€æ¬¡
        createContexts() {
            // â—â—â— æ–°ç‰ˆcanvaséœ€è¦æ¶ˆé™¤é”¯é½¿
            const windowInfo = wx.getWindowInfo();
            const availableWidth = windowInfo.windowWidth;
            const dpr = windowInfo.pixelRatio;//è®¾å¤‡åƒç´ æ¯”

            // 1. ç»™ context[] èµ‹å€¼ï¼ˆåœ¨è¿™ä¸ªé¡µé¢åªåˆ›å»ºä¸€æ¬¡ï¼‰
            this.tankList.forEach((tank, index) => {
                this.createSelectorQuery()
                    .select(`#${tank.id}`)
                    .node(({ node: canvas }) => {
                        this.context[index] = canvas.getContext('2d');
                        console.log('this.context[] å»ºç«‹æˆåŠŸ');

                        canvas.width = availableWidth * dpr;
                        canvas.height = availableWidth * 0.4 * dpr; //æŒ‰ç…§ä¸‹é¢cssçš„å°ºå¯¸æ¯”ä¾‹
                        this.context[index].scale(dpr, dpr); //å¿…é¡»æœ‰

                        //è¿™é‡Œè°ƒç”¨ä¸€éï¼Œé˜²æ­¢ç­‰å¾…æ—¶é—´è¿‡é•¿
                        this.refreshCanvas(this.bgimgWidth, this.bgimgHeight);
                    }).exec();
            })
        },
        refreshCanvas(bgimgWidth, bgimgHeight) {
            const context = this.context;

            // 2. è®¾ç½®ä¸åŒæ²¹ç½æ²¹å“çš„é¢œè‰²
            let oilColors = [];//å­˜å‚¨ä¸åŒæ²¹ç½æ²¹å“çš„é¢œè‰²
            this.tankList.forEach(tank => {
                oilColors.push(converIntToRgb(tank.oilColor));
            });

            this.tankList.forEach((tank, index) => {
                this.createSelectorQuery()
                    .select(`#hc${tank.id}`)
                    .node(({ node: canvas }) => {
                        this.bgImg = canvas.createImage();
                        this.bgImg.src = "/static/hcbgimg.png";
                        this.bgImg.onload = () => {
                            // â—â—â— æ¯æ¬¡ç”»æ–°çš„ä¹‹å‰å…ˆæ¸…ç©ºç”»å¸ƒï¼ˆåŒ…æ‹¬å›¾ç‰‡ï¼‰
                            this.context[index].clearRect(0, 0, bgimgWidth, bgimgHeight);
 
                            // æ–°ç‰ˆcanvasç”»èƒŒæ™¯å›¾ç‰‡,å°†å›¾ç‰‡ç»˜åˆ¶åˆ° canvas ä¸Š
                            this.context[index].drawImage(this.bgImg, 0, 0, bgimgWidth, bgimgHeight);

                            // å†™è¯¦ç»†ä¿¡æ¯(æ”¾å¤–é¢ä¼šè¢«å›¾ç‰‡æŒ¡ä½ï¼Œå› ä¸ºå›¾ç‰‡åŠ è½½è¾ƒæ…¢)
                            const textColor = tank.connect ? "black" : "red";
                            context[index].fillStyle = textColor;
                            context[index].font = "20px sans-serif";
                            context[index].fillText(tank.id, bgimgWidth * 0.06, bgimgHeight * 0.6);
                        }
                    }).exec();
            });
        },
         
    }
}
</script>

<style scoped>
.canvas {
    width: 750rpx;
    height: 300rpx;
    margin-top: 30rpx;
    margin-left: 37rpx;
    margin-right: 37rpx;
}
</style>
```

 