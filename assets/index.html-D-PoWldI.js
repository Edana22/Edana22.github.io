import{_ as e,c as a,d as i,o as n}from"./app-DoO5dwbX.js";const t="/assets/uniapp-13-rGJ_eE0q.png",l="/assets/uniapp-14-BEpnDs5E.png",p={};function d(c,s){return n(),a("div",null,s[0]||(s[0]=[i('<h2 id="中断表现" tabindex="-1"><a class="header-anchor" href="#中断表现"><span>中断表现</span></a></h2><p>上周开发微信小程序时新加了一个页面，复用了以前页面的逻辑，但是今天发现新加的页面出现了很奇怪的问题：</p><div class="hint-container caution"><p class="hint-container-title">进入新页面后，点一下查询再退出页面，mqtt 连接正常；进入新页面后，直接返回退出页面，mqtt 连接中断。</p></div><p><img src="'+t+'" alt="alt text"></p><p>mqtt 报错信息如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>WebSocket connection to &quot;wss://www.xxxx.com/mqtt&quot; failed:Close received after close</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="'+l+`" alt="alt text"></p><p>经过排查，发现小程序的生命周期 onUnload 和 onHide 里面都调用了取消订阅的方法 client.unsubscribe(subsTopic) ，但是不点查询的时候并没有订阅 subsTopic 。</p><p><mark>订阅之后多次取消订阅没有问题，但是没有订阅时调用取消订阅 mqtt 连接就会中断。</mark></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>onUnload() {</span></span>
<span class="line"><span>    console.log(&quot;卸载页面&quot;);</span></span>
<span class="line"><span>    this.clearTopic();</span></span>
<span class="line"><span>},</span></span>
<span class="line"><span>onHide() {</span></span>
<span class="line"><span>    console.log(&quot;隐藏页面&quot;);</span></span>
<span class="line"><span>    this.clearTopic();</span></span>
<span class="line"><span>},</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="解决办法" tabindex="-1"><a class="header-anchor" href="#解决办法"><span>解决办法</span></a></h2><p>去掉 onUnload 和 onHide 里的 this.clearTopic，在查询数据里面按照如下顺序执行代码：</p><div class="language-txt line-numbers-mode" data-highlighter="shiki" data-ext="txt" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-txt"><span class="line"><span>1.  订阅主题</span></span>
<span class="line"><span>2.  发布主题</span></span>
<span class="line"><span>3.  获取数据</span></span>
<span class="line"><span>4.  取消订阅主题。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">也可以在 unsubscribe 之前先检查一下 this.subsTopic ，不为空才取消定订阅，否则不取消。</p></div>`,14)]))}const o=e(p,[["render",d]]),h=JSON.parse('{"path":"/uniapp/eipby39o/","title":" 微信小程序 mqtt 连接中断原因","lang":"zh-CN","frontmatter":{"title":" 微信小程序 mqtt 连接中断原因","createTime":"2025/07/04 16:15:28","permalink":"/uniapp/eipby39o/"},"readingTime":{"minutes":1.04,"words":312},"git":{"createdTime":1751621436000,"updatedTime":1751866687000,"contributors":[{"name":"twoflowers","username":"","email":"1292548615@qq.com","commits":3,"avatar":"https://gravatar.com/avatar/51a398cd538d08b052e061e4b9f2c3353a7fae1d5406ef128cad6096d91bd325?d=retro"}]},"filePathRelative":"notes/uniapp/2.uniapp_debug/9.微信小程序 mqtt 连接中断原因.md","headers":[]}');export{o as comp,h as data};
